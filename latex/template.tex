% Dependencies for this design, XeLaTeX only (for OpenTypes)
\RequirePackage{fix-cm}
\RequirePackage[no-math]{fontspec}
\RequirePackage{multicol}
\RequirePackage[dvipsnames]{xcolor}
\RequirePackage{color}
\RequirePackage{tcolorbox} % used for section ornament, be careful in multicol for vertical alignments
\RequirePackage{polyglossia} % non-break space french punct, bug Warning: "Failed to patch part"


% TO TEST, maybe useful one day
% \RequirePackage{wrapfig}
% \RequirePackage{ragged2e}

% TESTED, bad
% \RequirePackage{background} % doesn’t work with xetek
% \RequirePackage{longtable} % doesn’t work in multicol
% \RequirePackage[normalem]{ulem} % Package multicol Warning: May not work
% \RequirePackage{framed} % doesn’t work in multicol

% memoir and koma does not work well for section titles and columns
\documentclass[french,oneside]{book} % not twoside, openany (default for report)
% packaged needing a documentclass context


\makeatletter % @@@

% before geometry, colors
\definecolor{rubric}{HTML}{902c20} % the tonic
\colorlet{borderline}{rubric!30!} % definecolor need exact code
\definecolor{shadecolor}{gray}{0.95}
\definecolor{bghi}{gray}{0.5}

% specific A4
\usepackage[%
  a4paper,
  inner=1.1cm, % do not presume recto/verso printing
  outer=1.1cm, 
  top=1.8cm,
  bottom=1.5cm,
  marginparsep=0pt,
]{geometry}
\setlength{\columnsep}{2cm}
\setlength{\columnseprule}{0.2pt}
\renewcommand{\columnseprulecolor}{\color{rubric}}
% indents
\setlength{\parindent}{1.5em}
\setlength{\parskip}{0pt}
% try to redefine quoting environment
\PassOptionsToPackage{utf8}{inputenc}

% Xetex only, Fonts
\defaultfontfeatures{Scale = MatchLowercase}
\defaultfontfeatures{Ligatures={TeX}}
% XeLaTeX is hard on small caps, lots have not
% \usepackage{Rosario} % bad shape, nosmallcaps, some weights, 10pt
\usepackage[]{roboto} % SmallCaps, Regular is a bit bold
% \usepackage{fira} % not in TexLive2020 
\usepackage{lato} % quite nice, weights, nosmallcaps, 10pt
% \usepackage{noto} % SmallCaps, 9.5pt
\setmainfont{Roboto Light}[%
  ItalicFont={Roboto Italic},
  % SmallCapsFont=Noto Sans,
  % SmallCapsFeatures={Letters=SmallCaps} % ensure sc enable for otf
]
\usepackage[fontsize=10pt]{scrextend} % 10pt for lato (53 c.)
% \newfontinstance\scshape[Letters=SmallCaps,Scale=1.15]{Crimson}
% \renewcommand{\baselinestretch}{0.95} % old doc ?
% \linespread{0.90} % too compact, keep font natural

\usepackage{DejaVuSans}
\setsansfont{Roboto Condensed}
\newfontfamily{\fontlight}{DejaVu Sans} % for abstract
\newfontfamily\syms{DejaVu Sans} % Ensure a font for dingBats (no in Lato or Noto))
\setmonofont{DejaVu Sans Mono}
\setmainlanguage{french}


% footnotes
% \renewcommand*{\marginfont}{\itshape\footnotesize}
% \patchcmd{\@footnotetext}{\footnotesize}{\small}{}{}
\renewcommand\footnoterule{\vspace*{0.3cm}\hrule height 0.1pt width 3cm \vspace*{0.3cm}}
\patchcmd{\@footnotetext}{\reset@font}{\fontfamily{phv}\selectfont}{}{}
\patchcmd{\@makefntext}{\hss\@makefnmark}{\@makefnmark}{}{}
\setlength\footnotesep{1.5\footnotesep} % footnote separator
\renewcommand{\thefootnote}{\bfseries\textcolor{rubric}{\arabic{footnote}}} % color for footnote marks
\renewcommand\@makefntext[1]{\parindent 1.5em \noindent \hb@xt@1.8em{\hss{\normalfont\@thefnmark . }}#1} % no superscipt in foot


% Metadata inserted, from the TEI source, for title page and runing heads

%meta%


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% <TEI> generic (LaTeX names generated) %
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\usepackage{etoolbox} % patch commands
\usepackage{enumitem} % <list>
\usepackage{tabularx} % <table>
\usepackage{verse} % <l>
\usepackage{hyperref} % supposed to be the last one, :o) except for the one to follow
\hyperbaseurl{}
\hypersetup{extension = }
\hypersetup{
  % pdftex, % no effect
  pdftitle={\shortref},
  % pdfauthor={Your name here},
  % pdfsubject={Your subject here},
  % pdfkeywords={keyword1, keyword2},
  bookmarksnumbered=true,
  bookmarksopen=true,
  bookmarksopenlevel=1,
  pdfstartview=Fit,
  % linktocpage=true, % toc, link only on page no 
  pdfpagemode=UseOutlines,    % pdf toc
  % pdfpagelayout=TwoPageRight,
  citebordercolor=0.75 0.75 0.75,
  linkbordercolor=0.75 0.75 0.75,
  urlbordercolor=0.75 0.75 0.75,
  colorlinks=true,
  allcolors=black,
}
\usepackage{bookmark} % after hyperref

% TOTEST
% \usepackage{hypcap} % links in caption ?
% \usepackage{xparse} % not yet used
% \usepackage{marginnote}


% Copied from Rahtz but not understood
\def\@pnumwidth{1.55em}
\def\@tocrmarg {2.55em}
\def\@dotsep{4.5}
\clubpenalty=8000
\emergencystretch 3em
\hbadness=4000
\hyphenpenalty=400
\pretolerance=750
\tolerance=2000
\vbadness=4000
\widowpenalty=10000
\def\Gin@extensions{.pdf,.png,.jpg,.mps,.tif}


% generic typo commands

\@ifundefined{syms}{\newcommand{\syms}{}} % this may not work outside XeTeX context because of ✻
\newcommand{\astermono}{\medskip\centerline{\color{rubric}\large\selectfont{\syms ✻}}\medskip\par}%
\newcommand{\astertri}{\bigskip\centerline{\color{rubric}\large\selectfont{\syms ✻\,✻\,✻}\medskip\par}}%
\newcommand{\asterism}{\bigskip\par\noindent\parbox{\linewidth}{\centering\color{rubric}\large{\syms ✻}\\{\syms ✻}\hskip 0.75em{\syms ✻}}\bigskip\par}%
\setlist{noitemsep,wide,leftmargin=*, labelindent=0pt} % labelindent=\parindent,leftmargin=*
\setlist[itemize]{label=—}


% General typo
\DeclareTextFontCommand{\textlarge}{\large}
\DeclareTextFontCommand{\textsmall}{\small}


% commands, inlines
\newcommand\abbr{}
\newcommand\corr{}
\newcommand\expan{}
\newcommand\gap{}
\newcommand\orig{}
\newcommand\orgName{}
\newcommand\persName{}
\newcommand\name{}
\newcommand\placeName{}
\newcommand\reg{}
% \newcommand\ref{} % already defined
\newcommand\sic{}

% commands, blocks
\newcommand{\byline}[1]{\vskip2em{\RaggedLeft{#1}\par}\vskip1em}
\newcommand{\dateline}[1]{\vskip1em{\RaggedLeft{#1}\par}\vskip2em}
\newcommand{\salute}[1]{\vskip2em{#1}\par\vskip1em}

% environments for blocks (should probably become commands)
\newenvironment{bibl}{}{}
\newenvironment{blabel}{\begin{center}\begin{bfseries}}{\end{bfseries}\end{center}}
\newenvironment{citbibl}{\ifvmode\hfill\fi}{\ifvmode\par\fi }
\newenvironment{docAuthor}{\ifvmode\vskip4pt\fontsize{16pt}{18pt}\selectfont\fi\itshape}{\ifvmode\par\fi }
\newenvironment{docDate}{}{\ifvmode\par\fi }
\newenvironment{docImprint}{\vskip6pt}{\ifvmode\par\fi }
\newenvironment{docTitle}{\vskip6pt\bfseries\fontsize{18pt}{22pt}\selectfont}{\par }
\newenvironment{msHead}{\vskip6pt}{\par}
\newenvironment{msItem}{\vskip6pt}{\par}
\newenvironment{titlePart}{}{\par }


% environments for block containers
\newenvironment{argument}{\fontlight\parindent0pt}{\vskip1.5em}
\newenvironment{biblfree}{}{\ifvmode\par\fi }
\newenvironment{bibitemlist}[1]{%
  \list{\@biblabel{\@arabic\c@enumiv}}%
  {%
    \settowidth\labelwidth{\@biblabel{#1}}%
    \leftmargin\labelwidth
    \advance\leftmargin\labelsep
    \@openbib@code
    \usecounter{enumiv}%
    \let\p@enumiv\@empty
    \renewcommand\theenumiv{\@arabic\c@enumiv}%
  }
  \sloppy
  \clubpenalty4000
  \@clubpenalty \clubpenalty
  \widowpenalty4000%
  \sfcode`\.\@m
}%
{\def\@noitemerr
  {\@latex@warning{Empty `bibitemlist' environment}}%
\endlist}
\usepackage[%
  indentfirst=false,
  rightmargin=0pt,
  vskip=1em,
  noorphanfirst=true,
  noorphanafter=true,
  leftmargin=\parindent
]{quoting}
\newenvironment{blockquote}% may be used for ornaments
  {\begin{quoting}}
  {\end{quoting}}

% table () is preceded and finished by custom command
\newcommand{\tableopen}[1]{% pdf@strcmp
  \ifnum\strcmp{#1}{wide}=0%
    {}
  \else\ifnum\strcmp{#1}{long}=0
    {}
  \else
    {}
  \fi\fi
}
\newcommand{\tableclose}[1]{% pdf@strcmp
  \ifnum\strcmp{#1}{wide}=0%
    {}
  \else\ifnum\strcmp{#1}{long}=0
    {}
  \else
    {}
  \fi\fi
}


% text structure
\newcommand\chapteropen{} % maybe useful for multicol settings
\newcommand\chapterclose{} % maybe useful for multicol settings
\usepackage[explicit]{titlesec} % NO implicit !, wear titles
\setcounter{secnumdepth}{-2} % no counters for hierarchy titles
\setcounter{tocdepth}{5}


%%%%%%%%%%%%%%
% </TEI> end %
%%%%%%%%%%%%%%

% \renewcommand{\@cite}[1]{#1}



%%% TEI overrides

% A4 two cols for chapters
\renewcommand\chapteropen{%
  \begin{multicols}{2}%
}
\renewcommand\chapterclose{%
  \par\medskip\noindent
  \end{multicols} 
  % \resizebox{\textwidth}{!}{\includegraphics[width=\columnwidth]{bandeau1.pdf}}
}

\renewcommand{\tableopen}[1]{% pdf@strcmp
  \ifnum\strcmp{#1}{wide}=0%
    {%
      \end{multicols} 
      \begin{center}
    }
  \else\ifnum\strcmp{#1}{long}=0
    {}
  \else
    {}
  \fi\fi
}
\renewcommand{\tableclose}[1]{% pdf@strcmp
  \ifnum\strcmp{#1}{wide}=0%
    {%
      \end{center}
      \begin{multicols}{2}%
    }
  \else\ifnum\strcmp{#1}{long}=0
    {}
  \else
    {}
  \fi\fi
}


% page models
\usepackage{fancyvrb}
\usepackage{fancyhdr}
\usepackage[fit]{truncate}
\markright{\@title}
\markboth{\@title}{\@author}

% here it is one side design, no need to define LO,LE
\fancypagestyle{plain}{% apply to chapter
  \fancyhf{}% clear all header and footer fields
  \setlength\headheight{16pt}
  \fancyhead[L]{\truncate{0.9\headwidth}{\shortref}}
  \fancyhead[R]{\thepage}
}
\fancypagestyle{fancy}{%
  \fancyhf{}
  \setlength{\headheight}{16pt}
  \let\oldheadrule\headrule % Copy \headrule into \oldheadrule
  \renewcommand{\headrule}{\color{rubric}\oldheadrule}% Add colour to \he
  \fancyhead{} % reset head
  \fancyfoot{} % reset foot
  \fancyhead[L]{\color{rubric}{\truncate{0.45\headwidth}{\shortref}}}
  \fancyhead[C]{{\thepage}}
  \fancyhead[R]{\color{rubric}{\nouppercase{\truncate{0.45\headwidth}{\leftmark}}}} % Chapter title
}




\tcbuselibrary{skins}
\usetikzlibrary{calc}
\usetikzlibrary{shadows}
\titleformat % delicate tuning, image has produce line-height problems in title on 2 lines 
  {name=\chapter} % command
  [display] % shape
  {\vspace{16pt}\raggedleft} % format
  {} % label
  {0pt} % separator between n
  {%
    % \noindent\resizebox{\textwidth}{!}{\includegraphics[width=\columnwidth]{bandeau.pdf}}
    % \vspace{16pt}
  } % before code
  [{\color{rubric}\huge\bfseries\sffamily #1}\vspace{16pt}] % after code
\titlespacing*{\chapter}{0pt}{-30pt}{0pt}[0pt]

\newtcolorbox{sectionbox}{%
  enhanced,
  width=\linewidth,
  colback=white,
  % coltext=white,
  colframe=black,
  frame hidden,
  boxrule=0.1pt,
  left=3pt,
  right=3pt,
  top=0pt,
  bottom=0pt,
  halign=flush right,
  lifted shadow={-0.5pt}{-2mm}{3mm}{0.1mm}{rubric}
}
\titleformat{name=\section}[hang]
  {\large\bfseries\sffamily} % filright ?
  {} % \thesection
  {}
% {\colorbox{bghi}{\parbox{\dimexpr\linewidth-2\fboxsep}{#1}}}
  {\begin{sectionbox}{#1}\end{sectionbox}
}

\titlespacing{\section}{0pt}{1.5em}{-10pt}{} % done by colorbox

\def\tableofcontents{\subsection{\contentsname}\@starttoc{toc}} % title of the toc in the toc





%%%

\makeatother % @@@


\begin{document}
\pagestyle{fancy}
\thispagestyle{empty}

\makeatletter% @@@
\noindent\parbox[b]{.75\textwidth}{\fontsize{13pt}{15pt}\color{rubric}\bfseries\raggedright\selectfont\@author{, }\@date}
\vskip10pt
\par\noindent{\fontsize{19pt}{21pt}\color{rubric}\itshape\raggedright\selectfont\@title}
\vspace{0pt}
\par\noindent\rule{\textwidth}{0.4pt}
\vspace{15pt}
\let\tabcellsep& 

% \fontname\font, \f@size pt, \textsc{Les règles du jeu}
\makeatother% @@@


%tei%


\end{document}

