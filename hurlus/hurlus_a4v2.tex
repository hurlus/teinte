%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% LaTeX model for hurlus booklets print %
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\RequirePackage{fix-cm}
\documentclass[french,twoside,notitlepage]{book}
\usepackage[%
  papersize={105mm, 297mm},
  % a5paper,
  inner=10mm, % recto/verso printing for booklet
  outer=10mm, 
  top=18mm,
  bottom=10mm,
  marginparsep=0pt,
]{geometry}

%%%%%%%%%%%%%%
% Alignments %
%%%%%%%%%%%%%%

\setlength{\columnsep}{2cm}
\setlength{\arrayrulewidth}{0.2pt}
% \setlength{\columnseprule}{0.2pt}
\setlength{\parskip}{0pt} % classical para with no margin
\setlength{\parindent}{1.5em}

%%%%%%%%%%
% Colors %
%%%%%%%%%%
% before Teinte macros

\usepackage[dvipsnames]{xcolor}
\definecolor{rubric}{HTML}{902c20} % the tonic
\colorlet{borderline}{rubric!30!} % definecolor need exact code
\definecolor{shadecolor}{gray}{0.95}
\definecolor{bghi}{gray}{0.5}

%%%%%%%%%%%%%
% footnotes %
%%%%%%%%%%%%%
\makeatletter
% \renewcommand*{\marginfont}{\itshape\footnotesize}
% \patchcmd{\@footnotetext}{\footnotesize}{\small}{}{}
\renewcommand\footnoterule{\vspace*{0.3cm}\hrule height \arrayrulewidth width 3cm \vspace*{0.3cm}}
\usepackage{patchcmd} % obsolete
% \patchcmd{\@footnotetext}{\reset@font}{\fontfamily{phv}\selectfont}{}{}
% \patchcmd{\@makefntext}{\hss\@makefnmark}{\@makefnmark}{}{}
\setlength\footnotesep{1.5\footnotesep} % footnote separator
\renewcommand{\thefootnote}{\bfseries\textcolor{rubric}{\arabic{footnote}}} % color for footnote marks
\renewcommand\@makefntext[1]{\parindent 1.5em \noindent \hb@xt@1.8em{\hss{\normalfont\@thefnmark . }}#1} % no superscipt in foot
\makeatother


%%%%%%%%%
% Fonts %
%%%%%%%%%
\usepackage[no-math]{fontspec}
\defaultfontfeatures{Scale = MatchLowercase}
\defaultfontfeatures{Ligatures={TeX}}
\usepackage[]{roboto} % SmallCaps, Regular is a bit bold
\setmainfont{Roboto Light}[%
  ItalicFont={Roboto Italic},
]
\usepackage[fontsize=9.5pt]{scrextend} % 10pt for lato (53 c.)
% \linespread{0.90} % too compact, keep font natural
\usepackage{DejaVuSans}
\setsansfont{Roboto Condensed}
\newfontfamily{\fontlight}{DejaVu Sans} % for abstract
\newfontfamily\syms{DejaVu Sans} % Ensure a font for dingBats (no in Lato or Noto))
\setmonofont{DejaVu Sans Mono}

%%%%%%%%
% MISC %
%%%%%%%%

\usepackage{polyglossia} % non-break space french punct, bug Warning: "Failed to patch part"
\setmainlanguage{french}
\PassOptionsToPackage{utf8}{inputenc}


\input{../latex/teinte}

\renewcommand{\pn}[1]{\vskip 5pt\noindent{\sffamily\footnotesize\bfseries\color{rubric} #1.}} % <p n="3"/>
\renewcommand{\headrulewidth}{\arrayrulewidth}
\renewcommand{\headrule}{\color{rubric}\hrule}
\fancypagestyle{fancy}{%
  \fancyhf{}
  \setlength{\headheight}{16pt}
  \fancyhead{} % reset head
  \fancyfoot{} % reset foot
  \fancyhead[LO]{\truncate{0.9\headwidth}{\nouppercase{\sffamily\shortref}}} % book ref
  \fancyhead[RE]{\truncate{0.9\headwidth}{\nouppercase{\sffamily\leftmark}}} % Chapter title
  \fancyhead[RO,LE]{\thepage}
}
\fancypagestyle{plain}{% apply to chapter
  \fancyhf{}% clear all header and footer fields
  \setlength{\headheight}{16pt}
  \fancyhead[L]{\truncate{0.9\headwidth}{\sffamily \shortref}}
  \fancyhead[R]{\thepage}
}

\titleformat % delicate tuning, image has produce line-height problems in title on 2 lines 
  {name=\chapter} % command
  % [display] % shape
  {\vspace{16pt}\centering} % format
  {} % label
  {0pt} % separator between n
  {% before code
    \noindent\resizebox{\textwidth}{!}{\includegraphics[width=\columnwidth]{img/bandeau.pdf}}
    % \vspace{16pt}
  }
  [{\color{rubric}\huge\bfseries\sffamily #1}\vspace{16pt}] % after code

\titlespacing*{\chapter}{0pt}{-30pt}{0pt}[0pt]

\iffalse
\titlespacing{\section}{0pt}{1.5em}{-10pt}{}
% bandeau avec texte au milieu
\noindent\centerline{\includegraphics[width=\columnwidth]{img/bandeau.pdf}}\vspace{-28pt}
\centerline{\fontsize{20pt}{35pt}\addfontfeature{LetterSpace=15}\color{white}\bfseries \contour{black}{Hurlus-lez-Textes}}\vspace{25pt}
\fi

\titleformat
  {name=\section}
  % [hang]
  {\color{rubric}\large\bfseries\sffamily\raggedleft} % filright ?
  {} % \thesection
  {}
  {#1}
\usepackage{contour}


\begin{document}
\pagestyle{fancy}
\thispagestyle{empty}


\makeatletter
\begin{center}
\includegraphics[width=\columnwidth]{img/bandeau.pdf}\vspace{15pt}
{\fontsize{19pt}{20pt}\addfontfeature{LetterSpace=25}\bfseries{\@author}}\par
\parbox{\fontsize{12pt}\selectfont\@date}\par
\vskip10pt
{\fontsize{19pt}{21pt}\selectfont\sffamily\emph{\@title}}
\makeatother
\vskip15pt
\centerline{\fontsize{8pt}{}\selectfont\color{rubric} {hurlus.fr, tiré le \today}}
{\color{rubric} \hline}
\vskip15pt
\end{center} 

\makeatletter\@starttoc{toc}\makeatother % toc without new page

\ifdev % autotext in dev mode
\fontname\font — \textsc{Les règles du jeu}
\Blinddocument
\fi

%tei%


\end{document}
